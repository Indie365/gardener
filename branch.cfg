cfgs:
  default:
    index: 0
    branches: ['master|rc|release-v.*']
    inherit:
      gardener:
        template: 'default'
        base_definition:
          repo: ~
          traits:
            version:
              preprocess:
                'inject-commit-hash'
              inject_effective_version: true
            publish:
              dockerimages:
                apiserver:
                  registry: 'gcr-readwrite'
                  image: 'eu.gcr.io/gardener-project/gardener/apiserver'
                  dockerfile: 'Dockerfile'
                  target: apiserver
                controller-manager:
                  registry: 'gcr-readwrite'
                  image: 'eu.gcr.io/gardener-project/gardener/controller-manager'
                  dockerfile: 'Dockerfile'
                  target: controller-manager
                scheduler:
                  registry: 'gcr-readwrite'
                  image: 'eu.gcr.io/gardener-project/gardener/scheduler'
                  dockerfile: 'Dockerfile'
                  target: scheduler
                gardenlet:
                  registry: 'gcr-readwrite'
                  image: 'eu.gcr.io/gardener-project/gardener/gardenlet'
                  dockerfile: 'Dockerfile'
                  target: gardenlet
                seed-admission-controller:
                  registry: 'gcr-readwrite'
                  image: 'eu.gcr.io/gardener-project/gardener/seed-admission-controller'
                  dockerfile: 'Dockerfile'
                  target: seed-admission-controller
        jobs:
          head-update:
            traits:
              component_descriptor: ~
              options:
                public_build_logs: true
          pull-request:
            traits:
              pull-request: ~
              component_descriptor: ~
              options:
                public_build_logs: true

  only-rc:
    index: 1
    branches: ['rc']
    inherit:
      gardener:
        base_definition:
          steps:
            verify:
              image: 'golang:1.14.2'
          traits:
            publish:
              dockerimages:
                seed-admission-controller:
                  registry: 'gcr-readwrite'
                  image: 'eu.gcr.io/gardener-project/gardener/seed-admission-controller'
                  dockerfile: 'Dockerfile'
                  target: seed-admission-controller

  only-master:
    index: 1
    branches: ['master']
    inherit:
      gardener-doc:
        jobs:
          generate-monitoring-docs:
            repo:
              trigger: false
            traits:
              cronjob:
                interval: '24h'
            steps:
              generate-monitoring-docs:
                execute:
                - generate_monitoring_docs
                publish_to:
                - source
      gardener:
        base_definition:
          steps:
            verify:
              image: 'golang:1.14.7'
            check-generate:
              image: 'golang:1.14.7'
          traits:
            publish:
              dockerimages:
                admission-controller:
                  registry: 'gcr-readwrite'
                  image: 'eu.gcr.io/gardener-project/gardener/admission-controller'
                  dockerfile: 'Dockerfile'
                  target: admission-controller
        jobs:
          head-update:
            traits:
              draft_release: ~
              version:
                inject_effective_version: true
          integration-test:
            repo:
              trigger: false
            traits:
              component_descriptor: ~
              notifications:
                test_breakers:
                  on_error:
                    triggering_policy: 'always'
                    recipients:
                    - email_addresses:
                      - dieter.guendisch@sap.com
                      - tim.schrodi@sap.com
                      - oleg.loewen@sap.com
                    inputs:
                    - component_descriptor_dir
            steps:
              components:
                image: eu.gcr.io/gardener-project/gardener/testmachinery/base-step:latest
                output_dir: out
                notifications_cfg: 'test_breakers'
                depends:
                - publish
                - component_descriptor
                inputs:
                  component_descriptor_dir: component_descriptor_dir
                execute:
                - ./get_latest_release_component_descriptor
              test:
                image: eu.gcr.io/gardener-project/gardener/testmachinery/testmachinery-run:stable
                notifications_cfg: 'test_breakers'
                depends:
                - components
                - component_descriptor
                inputs:
                  OUT_PATH: out_path
                  component_descriptor_dir: component_descriptor_dir
                execute:
                - tm-test
                - --tm-chart=default
                - --landscape=gardener
                - --tm-landscape=external
                - --
                - --testrun-prefix=gardener
          release:
            traits:
              version:
                preprocess: 'finalize'
              release:
                nextversion: 'bump_minor'
              slack:
                default_channel: 'internal_scp_workspace'
                channel_cfgs:
                  internal_scp_workspace:
                    channel_name: 'sap-tech-gardener'
                    slack_cfg_name: 'scp_workspace'
              component_descriptor: ~
              publish:
                dockerimages:
                  apiserver:
                    tag_as_latest: true
                  controller-manager:
                    tag_as_latest: true
                  scheduler:
                    tag_as_latest: true
                  gardenlet:
                    tag_as_latest: true
                  seed-admission-controller:
                    tag_as_latest: true
      gardener-updates:
        template: 'default'
        jobs:
          create_upgrade_prs:
            steps: ~
            traits:
              component_descriptor: ~
              update_component_deps: ~
              cronjob:
                interval: '2.5m'
              version: ~

  at-least-1-11:
    index: 1
    branches: ['release-v1\.(?!10).*$']
    inherit:
      gardener:
        base_definition:
          traits:
            publish:
              dockerimages:
                admission-controller:
                  registry: 'gcr-readwrite'
                  image: 'eu.gcr.io/gardener-project/gardener/admission-controller'
                  dockerfile: 'Dockerfile'
                  target: admission-controller
                  tag_as_latest: true

  release-branches:
    index: 1
    branches: ['release-v1\..*$']
    inherit:
      gardener:
        base_definition:
          steps:
            verify:
              image: 'golang:1.14.2'
          traits:
            publish:
              dockerimages:
                seed-admission-controller:
                  registry: 'gcr-readwrite'
                  image: 'eu.gcr.io/gardener-project/gardener/seed-admission-controller'
                  dockerfile: 'Dockerfile'
                  target: seed-admission-controller
        jobs:
          head-update:
            traits:
              draft_release: ~
              version:
                inject_effective_version: true
          release:
            traits:
              version:
                preprocess: 'finalize'
              release:
                nextversion: 'bump_patch'
              slack:
                default_channel: 'internal_scp_workspace'
                channel_cfgs:
                  internal_scp_workspace:
                    channel_name: 'sap-tech-gardener'
                    slack_cfg_name: 'scp_workspace'
              component_descriptor: ~
              publish:
                dockerimages:
                  apiserver:
                    tag_as_latest: true
                  controller-manager:
                    tag_as_latest: true
                  scheduler:
                    tag_as_latest: true
                  gardenlet:
                    tag_as_latest: true
                  seed-admission-controller:
                    tag_as_latest: true
