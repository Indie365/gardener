apiVersion: v1
kind: ConfigMap
metadata:
  name: aggregate-prometheus-config
  namespace: {{ .Release.Namespace }}
data:
  prometheus.yaml: |

    scrape_configs:
    - job_name: prometheus
      honor_timestamps: false
      metrics_path: /federate
      params:
        'match[]':
        - '{__name__=~"metering:.+", __name__!~"metering:.+(over_time|_seconds|:this_month)"}'
        - '{__name__=~"seed:(.+):(.+)"}'
        - '{job="kube-state-metrics",namespace=~"garden|extension-.+"}'
        - '{job="kube-state-metrics",namespace=""}'
        - '{job="cadvisor",namespace=~"garden|extension-.+"}'
      kubernetes_sd_configs:
      - role: service
        namespaces:
          names: [ garden ]
      relabel_configs:
      - source_labels:
        - __meta_kubernetes_service_name
        - __meta_kubernetes_service_port_name
        regex: prometheus-cache;web
        action: keep

{{- if .Values.aggregatePrometheus.additionalScrapeConfigs }}
{{ toString .Values.aggregatePrometheus.additionalScrapeConfigs | indent 4 }}
{{- end }}
